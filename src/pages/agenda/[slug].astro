---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import EventNavigation from "../../components/EventNavigation";

export const prerender = true;

export async function getStaticPaths() {
  const events = await getCollection("events");

  return events.map((event: CollectionEntry<"events">) => ({
    params: { slug: event.slug },
    props: { event, allEvents: events },
  }));
}
interface Props {
  event: CollectionEntry<"events">;
  allEvents: CollectionEntry<"events">[];
}
const { event, allEvents } = Astro.props as Props;
if (!event) {
  return Astro.redirect("/agenda");
}
const { Content } = await event.render();
const now = new Date();
const isPast = event.data.date < now;
// Préparer les données pour le composant React
const eventsData = allEvents.map((e) => ({
  slug: e.slug,
  title: e.data.title,
  date: e.data.date,
}));
---
<Layout title={event.data.title}>
  <main class="bg-white">
    <!-- Lien retour "Tous les Événements" -->
    <div class="bg-gray-100 py-4">
      <div class="max-w-6xl mx-auto px-4">
        <a href="/agenda" class="text-sm text-gray-700 hover:text-gray-900">
          « Tous les Événements
        </a>
      </div>
    </div>
    <!-- Badge "Cet événement est passé" -->
    {
      isPast && (
        <div class="bg-white py-4 border-b">
          <div class="max-w-6xl mx-auto px-4">
            <p class="text-sm text-gray-600">Cet événement est passé</p>
          </div>
        </div>
      )
    }
    <div class="max-w-6xl mx-auto px-4 py-8">
      <!-- Titre -->
      <h1 class="text-4xl font-bold text-gray-900 mb-3">{event.data.title}</h1>
      <!-- Date complète -->
      <p class="text-base text-gray-700 mb-6">{event.data.datetime}</p>
      <!-- Image pleine largeur -->
      <div class="mb-8">
        <img
          src={event.data.image}
          alt={event.data.title}
          class="w-full h-auto object-contain"
          loading="lazy"
        />
      </div>
      <!-- Contenu Markdown -->
      <article class="prose prose-lg max-w-none mb-12 !text-gray-800">
        <Content />
      </article>

      <!-- Grille 4 colonnes : DÉTAILS + ORGANISATEUR + LIEU + GOOGLE MAP -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-12">
        <!-- DÉTAILS -->
        <div>
          <h3 class="text-lg font-bold text-gray-900 mb-4 uppercase">
            Détails
          </h3>
          <div class="space-y-4">
            <div>
              <p class="text-sm font-semibold text-gray-800 mb-1">Date :</p>
              <p class="text-sm text-gray-600">
                {event.data.datetime.split("@")[0].trim()}
              </p>
            </div>
            {
              event.data.datetime.includes("@") && (
                <div>
                  <p class="text-sm font-semibold text-gray-800 mb-1">
                    Heure :
                  </p>
                  <p class="text-sm text-gray-600">
                    {event.data.datetime.split("@")[1].trim()}
                  </p>
                </div>
              )
            }
            {
              event.data.venueWebsite && (
                <div>
                  <p class="text-sm font-semibold text-gray-800 mb-1">Site :</p>
                  <a
                    href={event.data.venueWebsite}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sm text-blue-700 hover:underline break-all"
                  >
                    {event.data.venueWebsite}
                  </a>
                </div>
              )
            }
          </div>
        </div>
        <!-- ORGANISATEUR -->
        <div>
          <h3 class="text-lg font-bold text-gray-900 mb-4 uppercase">
            Organisateur
          </h3>
          {
            event.data.organizer && (
              <>
                <p class="text-sm font-semibold text-gray-800 mb-3">
                  {event.data.organizer}
                </p>

                {event.data.organizerEmail && (
                  <div class="mb-3">
                    <p class="text-xs font-semibold text-gray-700 mb-1">
                      E-mail
                    </p>
                    <p class="text-sm text-gray-600 break-all">
                      {event.data.organizerEmail}
                    </p>
                  </div>
                )}
                {event.data.organizerWebsite && (
                  <a
                    href={event.data.organizerWebsite}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sm text-blue-700 hover:underline"
                  >
                    Voir le site Organisateur
                  </a>
                )}
              </>
            )
          }
        </div>

        <!-- LIEU + PHONE -->
        <div>
          <h3 class="text-lg font-bold text-gray-900 mb-4 uppercase">Lieu</h3>

          <p class="text-sm font-semibold text-gray-800 mb-2">
            {event.data.location}
          </p>

          {
            event.data.address && (
              <div class="text-sm text-gray-600 mb-3 space-y-1">
                <p>{event.data.address}</p>
                <p>
                  {event.data.city && `${event.data.city}, `}
                  {event.data.postalCode} {event.data.country}
                </p>
              </div>
            )
          }

          {
            event.data.phone && (
              <div class="mb-3">
                <p class="text-xs font-semibold text-gray-700 mb-1">Phone</p>
                <p class="text-sm text-gray-600">{event.data.phone}</p>
              </div>
            )
          }

          {
            event.data.venueWebsite && (
              <a
                href={event.data.venueWebsite}
                target="_blank"
                rel="noopener noreferrer"
                class="text-sm text-blue-700 hover:underline block"
              >
                Voir Lieu site web
              </a>
            )
          }
        </div>
        <!-- GOOGLE MAP (4ème colonne) -->
        <div>
          {
            (event.data.googleMapsUrl || event.data.address) && (
              <div>
                <iframe
                  src={`https://maps.google.com/maps?q=${encodeURIComponent(event.data.address + ", " + event.data.city + ", " + event.data.country)}&output=embed`}
                  width="100%"
                  height="250"
                  style="border:0; border-radius: 4px;"
                  allowfullscreen=""
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  title="Carte de localisation"
                />
                <div class="mt-2">
                  <a
                    href={
                      event.data.googleMapsUrl ||
                      `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.data.address + ", " + event.data.city)}`
                    }
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sm text-blue-700 hover:underline inline-flex items-center gap-1"
                  >
                    + Google Map
                  </a>
                </div>
                <p class="text-xs text-gray-500 mt-1">Agrandir le plan</p>
              </div>
            )
          }
        </div>
      </div>
      <!-- Navigation événement (composant React) -->
      <EventNavigation
        client:load
        currentSlug={event.slug}
        allEvents={eventsData}
      />
    </div>
  </main>
</Layout>
